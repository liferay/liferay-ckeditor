From 89bb0448650c0da2a1251e309e9485e6dcd128cc Mon Sep 17 00:00:00 2001
From: Julien Castelain <julien.castelain@liferay.com>
Date: Tue, 7 Jul 2020 09:47:27 +0200
Subject: [PATCH] LPS-112982 Add additional resource URL parameters

---
 core/ckeditor_base.js | 23 ++++++++++++++++++-----
 core/config.js        |  9 +++++++++
 2 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/core/ckeditor_base.js b/core/ckeditor_base.js
index 81a33e0b1e..31c9034ece 100644
--- a/core/ckeditor_base.js
+++ b/core/ckeditor_base.js
@@ -175,13 +175,26 @@ if ( !window.CKEDITOR ) {
 			 * @returns {String} The full URL.
 			 */
 			getUrl: function( resource ) {
-				// If this is not a full or absolute path.
-				if ( resource.indexOf( ':/' ) == -1 && resource.indexOf( '/' ) !== 0 )
-					resource = this.basePath + resource;
+				var resourceUrl = resource.startsWith(this.basePath)
+					? new URL(resource)
+					: new URL(this.basePath + resource);
 
-				resource = this.appendTimestamp( resource );
+				if (!resourceUrl.toString().endsWith('/')) {
+					if (this.timestamp && !resourceUrl.searchParams.has('t')) {
+						resourceUrl.searchParams.set('t', this.timestamp);
+					}
 
-				return resource;
+					Object.entries(CKEDITOR.ADDITIONAL_RESOURCE_PARAMS).forEach(function(entries) {
+						var key = entries[0];
+						var value = entries[1];
+
+						if (!resourceUrl.searchParams.has(key)) {
+							resourceUrl.searchParams.set(key, value);
+						}
+					});
+				}
+
+				return resourceUrl.toString();
 			},
 
 			/**
diff --git a/core/config.js b/core/config.js
index 34cc8f1527..8d443e54d3 100644
--- a/core/config.js
+++ b/core/config.js
@@ -8,6 +8,15 @@
  * default configuration settings.
  */
 
+/**
+ * A map of optional additional parameters that will be
+ * added to a resource's URL
+ *
+ * @property {Object}
+ * @member CKEDITOR
+ */
+CKEDITOR.ADDITIONAL_RESOURCE_PARAMS = {};
+
 /**
  * Used in conjunction with the {@link CKEDITOR.config#enterMode}
  * and {@link CKEDITOR.config#shiftEnterMode} configuration
